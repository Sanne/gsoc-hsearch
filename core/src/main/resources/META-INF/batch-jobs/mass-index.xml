<?xml version="1.0" encoding="UTF-8"?>
<!--
 ~ Hibernate Search, full-text search for your domain model
 ~
 ~ License: GNU Lesser General Public License (LGPL), version 2.1 or later
 ~ See the lgpl.txt file in the root directory or <http://www.gnu.org/licenses/lgpl-2.1.html>.
  -->
<job id="massIndex" xmlns="http://xmlns.jcp.org/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd" version="1.0">

    <listeners>
        <listener ref="jobContextSetupListener">
            <properties>
                <property name="rootEntities" value="#{jobParameters['rootEntities']}" />
            </properties>
        </listener>
    </listeners>

    <step id="beforeChunk" next="produceLuceneDoc">
        <batchlet ref="beforeChunkBatchlet">
            <properties>
                <property name="optimizeAfterPurge" value="#{jobParameters['optimizeAfterPurge']}" />
                <property name="purgeAtStart" value="#{jobParameters['purgeAtStart']}" />
            </properties>
        </batchlet>
    </step>

    <step id="produceLuceneDoc" next="afterChunk">
        <chunk checkpoint-policy="custom">
            <reader ref="itemReader">
                <properties>
                    <property name="entityName" value="#{partitionPlan['entityName']}" />
                    <property name="maxResults" value="#{jobParameters['maxResults']}?:10000000;" />
                    <property name="scrollInterval" value="#{partitionPlan['scrollInterval']}" />
                    <property name="scrollOffset" value="#{partitionPlan['scrollOffset']}" />
                </properties>
            </reader>
            <processor ref="itemProcessor">
                <properties>
                    <property name="entityName" value="#{partitionPlan['entityName']}" />
                    <property name="persistenceUnitName" value="#{jobParameters['persistenceUnitName']}" />
                </properties>
            </processor>
            <writer ref="itemWriter">
                <properties>
                    <property name="entityName" value="#{partitionPlan['entityName']}" />
                </properties>
            </writer>
            <checkpoint-algorithm ref="checkpointAlgorithm">
                <properties>
                    <property name="itemCount" value="#{jobParameters['itemCount']}?:3;" />
                </properties>
            </checkpoint-algorithm>
        </chunk>
        <partition>
            <mapper ref="partitionMapper">
                <properties>
                    <property name="maxThreads" value="#{jobParameters['threads']}?:8;" />
                    <property name="partitions" value="#{jobParameters['partitions']}?:0;" />
                </properties>
            </mapper>
            <collector ref="partitionCollector" />
            <analyzer ref="partitionAnalyzer" />
        </partition>
    </step>

    <step id="afterChunk">
        <batchlet ref="afterChunkBatchlet">
            <properties>
                <property name="optimizeAtEnd" value="#{jobParameters['optimizeAtEnd']}" />
            </properties>
        </batchlet>
    </step>
</job>
